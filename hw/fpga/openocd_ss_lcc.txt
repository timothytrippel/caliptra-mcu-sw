# Licensed under the Apache-2.0 license

adapter driver sysfsgpio
adapter speed 1000

# Get the number of the versal_gpio gpiochip. This corresponds to the LPD GPIO controller
regexp {.*gpiochip(\d*)/.*} [exec grep -H versal_gpio {*}[glob /sys/class/gpio/*/label]] trash gpionum
puts stderr [glob /sys/class/gpio/*/label]
puts stderr [exec grep pmc_gpio {*}[glob /sys/class/gpio/*/label]]

# PL EMIO starts at pin 26
# 26-30 -> Caliptra Core JTAG
# 31-35 -> MCU JTAG
# 36-41 -> LCC JTAG
puts "Connecting to LCC"
set gpionum [expr {$gpionum + 36}]
set _CHIPNAME lc_ctrl
set _TAPNAME tap

# Define pin numbers for sysfsgpio
sysfsgpio tck_num [expr {$gpionum + 0}]
sysfsgpio tdi_num [expr {$gpionum + 1}]
sysfsgpio tms_num [expr {$gpionum + 2}]
sysfsgpio trst_num [expr {$gpionum + 3}]
sysfsgpio tdo_num [expr {$gpionum + 4}]

transport select jtag
reset_config none
# reset_config trst_nogate
# reset_config srst_nogate
# reset_config connect_assert_srst
# reset_config connect_assert_trst

set chain_length 5
set _TARGETNAME $_CHIPNAME.$_TAPNAME
jtag newtap $_CHIPNAME $_TAPNAME -irlen $chain_length -expected-id 0x00000001
target create $_TARGETNAME riscv -chain-position $_TARGETNAME -rtos hwthread

puts stderr "OpenOCD setup finished"
